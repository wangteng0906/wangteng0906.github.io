<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>LVS小记</title>
      <link href="/post/0ddasd.html"/>
      <url>/post/0ddasd.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h1><h2 id="keepalived配置文件参考"><a href="#keepalived配置文件参考" class="headerlink" title="keepalived配置文件参考"></a>keepalived配置文件参考</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[getui@bjmjq-service-10-9 ~]$ <span class="built_in">cat</span> /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id bjmjqWeb</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP              <span class="comment">#指定keepalived的角色，MASTER表示此主机是主服务器，BACKUP表示此主机是备用服务器</span></span><br><span class="line">    interface  bond0    <span class="comment">#指定HA监测网络的接口</span></span><br><span class="line">    virtual_router_id 119      <span class="comment">#虚拟路由标识，这个标识是一个数字，同一个vrrp实例使用唯一的标识。即同一vrrp_instance下，MASTER和BACKUP必须是一致的</span></span><br><span class="line">    priority 90              <span class="comment">#定义优先级，数字越大，优先级越高，在同一个vrrp_instance下，MASTER的优先级必须大于BACKUP的优先级</span></span><br><span class="line">    advert_int 1              <span class="comment">#设定MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒</span></span><br><span class="line">    authentication &#123;          <span class="comment">#设置验证类型和密码</span></span><br><span class="line">        auth_type PASS        <span class="comment">#设置验证类型，主要有PASS和AH两种</span></span><br><span class="line">        auth_pass mimazaizhe        <span class="comment">#设置验证密码，在同一个vrrp_instance下，MASTER与BACKUP必须使用相同的密码才能正常通信</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;       <span class="comment">#设置虚拟IP地址，可以设置多个虚拟IP地址，每行一个</span></span><br><span class="line">        10.16.10.248</span><br><span class="line">        10.16.10.249</span><br><span class="line">10.16.10.247</span><br><span class="line">10.16.10.246</span><br><span class="line">10.16.10.244</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.16.10.248 80 &#123;     <span class="comment">#设置虚拟服务器，需要指定虚拟IP地址和服务端口，IP与端口之间用空格隔开</span></span><br><span class="line">    delay_loop 6                        <span class="comment">#设置运行情况检查时间，单位是秒</span></span><br><span class="line">    lb_algo wlc                          <span class="comment">#设置负载调度算法，这里设置为rr，即轮询算法</span></span><br><span class="line">    lb_kind DR                          <span class="comment">#设置LVS实现负载均衡的机制，有NAT、TUN、DR三个模式可选</span></span><br><span class="line">    nat_mask 255.255.255.0</span><br><span class="line">    persistence_timeout 0               <span class="comment">#会话保持时间，单位是秒。这个选项对动态网页是非常有用的，为集群系统中的session共享提供了一个很好的解决方案。</span></span><br><span class="line">                                        <span class="comment">#有了这个会话保持功能，用户的请求会被一直分发到某个服务节点，直到超过这个会话的保持时间。</span></span><br><span class="line">                                        <span class="comment">#需要注意的是，这个会话保持时间是最大无响应超时时间，也就是说，用户在操作动态页面时，如果50秒内没有执行任何操作</span></span><br><span class="line">                                        <span class="comment">#那么接下来的操作会被分发到另外的节点，但是如果用户一直在操作动态页面，则不受50秒的时间限制</span></span><br><span class="line">    protocol TCP                        <span class="comment">#指定转发协议类型，有TCP和UDP两种</span></span><br><span class="line"></span><br><span class="line">    real_server 10.16.10.2 80 &#123;     <span class="comment">#配置服务节点1，需要指定real server的真实IP地址和端口，IP与端口之间用空格隔开</span></span><br><span class="line">        weight 1                        <span class="comment">#配置服务节点的权值，权值大小用数字表示，数字越大，权值越高，设置权值大小可以为不同性能的服务器</span></span><br><span class="line">                                        <span class="comment">#分配不同的负载，可以为性能高的服务器设置较高的权值，而为性能较低的服务器设置相对较低的权值，这样才能合理地利用和分配系统资源</span></span><br><span class="line">        TCP_CHECK &#123;                     <span class="comment">#realserver的状态检测设置部分，单位是秒</span></span><br><span class="line">            connect_timeout 3           <span class="comment">#表示3秒无响应超时</span></span><br><span class="line">            nb_get_retry 3              <span class="comment">#表示重试次数</span></span><br><span class="line">            delay_before_retry 3        <span class="comment">#表示重试间隔</span></span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="选举策略"><a href="#选举策略" class="headerlink" title="选举策略"></a>选举策略</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1、keepalived集群中MASTER和BACKUP角色选举策略：</span><br><span class="line">  在keepalived集群中，其实并没有严格意义上的主备节点，虽然可以在配置文件中设置MASTER状态，但是这并不意味着此节点一直就是MASTER状态。控制节点角色的是配置文件中的priority值，但它并不控制所有节点的角色，另一个能改变角色的是在vrrp_script模块中设置的weight值，这两个选项的值嗾使整数值(weight可以为负整数)，一个节点在集群中的角色就是通过这两个值的大小决定的；在vrrp_script模块中，如果不设置weight的值，那么集群优先级的选择将由配置文件中的priority值决定；</span><br><span class="line"></span><br><span class="line">2、使用vrrp_script模块时集群角色的选举算法</span><br><span class="line"></span><br><span class="line">（1）weight值为正数时</span><br><span class="line">在vrrp_script中指定的脚本如果检测成功，那么MASTER节点的权值将是weight值与priority值之和；如果检测失败，那么MASTER节点的权值保持为priority值，因此，切换策略为：</span><br><span class="line"></span><br><span class="line">    MASTER节点vrrp_script脚本检测失败时，如果MASTER节点priority值小于BACKUP节点weight值与priority值之和，将发生主备切换；</span><br><span class="line">    MASTER节点vrrp_script脚本检测成功时，如果MASTER节点weight值与priority之和大于BACKUP节点weight值与priority值之和，主节点依然为主节点，不发生切换；</span><br><span class="line"></span><br><span class="line">（2）weight值为负数时</span><br><span class="line">在vrrp_script中指定的脚本如果检测成功，那么MASTER节点的权值仍是priority值；如果检测失败，那么MASTER节点的权值将是priority值与weight值之差，因此，切换策略为：</span><br><span class="line"></span><br><span class="line">    MASTER节点vrrp_script脚本检测失败时，如果MASTER节点priority值与weight值之差小于BACKUP节点的priority值，将发生主备切换；</span><br><span class="line">    MASTER节点vrrp_script脚本检测成功时，如果MASTER节点priority值大于BACKUP节点priority值时，主节点依然为主节点，不发生切换；</span><br></pre></td></tr></table></figure><h3 id="LVS-nginx-keepalived搭建详情"><a href="#LVS-nginx-keepalived搭建详情" class="headerlink" title="LVS+nginx+keepalived搭建详情"></a><a href="https://blog.csdn.net/weixin_45405982/article/details/122905763?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170079241816800182179868%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=170079241816800182179868&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-16-122905763-null-null.142%5Ev96%5Epc_search_result_base7&utm_term=lvs%20keepalived%20nginx%E6%90%AD%E5%BB%BA&spm=1018.2226.3001.4187">LVS+nginx+keepalived搭建详情</a></h3><h3 id="ipvsadm命令详解"><a href="#ipvsadm命令详解" class="headerlink" title="ipvsadm命令详解"></a>ipvsadm命令详解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ipvsadm -Ln --rate  显示状态以及每个后端服务器的连接速率</span></span><br><span class="line">Prot LocalAddress:Port                 CPS    InPPS   OutPPS    InBPS   OutBPS</span><br><span class="line">  -&gt; RemoteAddress:Port</span><br><span class="line">TCP  10.10.14.248:5266                   4     2182        0  4925261        0</span><br><span class="line">  -&gt; 10.10.14.8:5266                     0      102        0   171532        0</span><br><span class="line">  -&gt; 10.10.14.9:5266                     0      529        0  1183525        0</span><br><span class="line">  -&gt; 10.10.14.12:5266                    0     1034        0  2654307        0</span><br><span class="line">  每个后端服务器的连接速率：</span><br><span class="line">Prot：协议类型（这里是 TCP）。</span><br><span class="line">LocalAddress:Port：本地监听地址和端口。</span><br><span class="line">CPS：每秒连接数（Connections Per Second）</span><br><span class="line">InPPS：每秒接收数据包数（Incoming Packets Per Second）</span><br><span class="line">OutPPS：每秒发送数据包数（Outgoing Packets Per Second）</span><br><span class="line">InBPS：每秒接收字节数（Incoming Bytes Per Second）</span><br><span class="line">OutBPS：每秒发送字节数（Outgoing Bytes Per Second）</span><br><span class="line"><span class="comment"># ipvsadm -Ln --stats  统计信息</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=1048576)</span><br><span class="line">Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes</span><br><span class="line">  -&gt; RemoteAddress:Port</span><br><span class="line">TCP  10.10.14.248:5266              110476 24749746        0   42308M        0</span><br><span class="line">  -&gt; 10.10.14.8:5266                     0  2179689        0    3403M        0</span><br><span class="line">  -&gt; 10.10.14.9:5266                    11  6132329        0   10738M        0</span><br><span class="line">  -&gt; 10.10.14.12:5266                    0  8691689        0   17337M        0</span><br><span class="line">  -&gt; 10.10.14.25:5266                   11  4839854        0    7719M        0</span><br><span class="line">  -&gt; 10.10.14.27:5266                37694   934186        0  999095K        0</span><br><span class="line">  -&gt; 10.10.14.28:5266                50412  1414498        0    1552M        0</span><br><span class="line">  -&gt; 10.10.14.29:5266                22370   558285        0  557957K        0</span><br><span class="line"><span class="comment">#统计信息 (--stats)：</span></span><br><span class="line">Conns：连接数，表示当前连接到该服务的连接数总和。</span><br><span class="line">InPkts：接收的数据包数量总和。</span><br><span class="line">OutPkts：发送的数据包数量总和。</span><br><span class="line">InBytes：接收的字节数总和。</span><br><span class="line">OutBytes：发送的字节数总和。</span><br><span class="line"></span><br><span class="line"><span class="comment">#ipvsadm -Ln  当前情况</span></span><br></pre></td></tr></table></figure><h3 id="lvs中ipvsadm的ActiveConn和InActConn的深入理解"><a href="#lvs中ipvsadm的ActiveConn和InActConn的深入理解" class="headerlink" title="lvs中ipvsadm的ActiveConn和InActConn的深入理解"></a>lvs中ipvsadm的ActiveConn和InActConn的深入理解</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActiveConn是活动连接数,也就是tcp连接状态的ESTABLISHED;InActConn是指除了ESTABLISHED以外的,所有的其它状态的tcp连接.那既然这样,为什么从lvs里看的ActiveConn会比在真实机上通过netstats看到的ESTABLISHED高很多呢?问得好!这也是笔者一直迷惑而渐渐清晰的一个问题.原来lvs自身也有一个默认超时时间.可以用ipvsadm -L --timeout查看,默认是900 120 300,分别是TCP TCPFIN UDP的时间.也就是说一条tcp的连接经过lvs后,lvs会把这台记录保存15分钟,而不管这条连接是不是已经失效!所以如果你的服务器在15分钟以内有大量的并发请求连进来的时候,你就会看到这个数值直线上升.</span><br><span class="line">其实很多时候,我们看lvs的这个连接数是想知道现在的每台机器的真实连接数吧?怎么样做到这一点呢?其实知道现在的ActiveConn是怎样产生的,做到这一点就简单了.举个例子:比如你的lvs是用来负载网站,用的模式是dr,后台的web server用的nginx.这时候一条请求过来,在程序没有问题的情况下,一条连接最多也就五秒就断开了.这时候你可以这样设置:ipvsadm --set 5 10 300.设置tcp连接只保持5秒中.如果现在ActiveConn很高你会发现这个数值会很快降下来,直到降到和你用nginx的status看当前连接数的时候差不多.你可以继续增加或者减小5这个数值,直到真实机的status连接数和lvs里的ActiveConn一致.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 中间件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LVS </tag>
            
            <tag> Linux </tag>
            
            <tag> Centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/post/4a17b156.html"/>
      <url>/post/4a17b156.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
